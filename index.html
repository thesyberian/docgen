<!DOCTYPE html>
<html lang="en-GB" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocGen 2.0</title>
    <meta name="description" content="A client-side tool for generating purchase orders, delivery notes, and other documents. All data is stored locally in your browser.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* --- Base Styles & Theming using CSS Variables --- */
        :root {
            --bg-primary: #f7f8fa; --bg-secondary: #ffffff; --bg-tertiary: #f1f3f6;
            --sidebar-bg: rgba(255, 255, 255, 0.7);
            --text-primary: #1a202c; --text-secondary: #4a5568; --text-inactive: #718096;
            --border-primary: #e2e8f0; --border-secondary: #edf2f7;
            --input-bg: #ffffff; --input-text: #1a202c; --input-border: #cbd5e0;
            --ring-color: #00528a; --placeholder-color: #a0aec0;
            --hover-bg: #edf2f7; --hover-text: #1a202c;
            --brand-color: #00528a; --brand-color-hover: #00416d;
            --button-destructive-bg: #e53e3e; --button-destructive-hover: #c53030;
            --aog-color: #e53e3e;
        }

        .dark {
            --bg-primary: #1a202c; --bg-secondary: #2d3748; --bg-tertiary: #4a5568;
            --sidebar-bg: rgba(26, 32, 44, 0.7);
            --text-primary: #f7fafc; --text-secondary: #a0aec0; --text-inactive: #718096;
            --border-primary: #4a5568; --border-secondary: #2d3748;
            --input-bg: #4a5568; --input-text: #f7fafc; --input-border: #718096;
            --ring-color: #4299e1; --placeholder-color: #718096;
            --hover-bg: #4a5568; --hover-text: #f7fafc;
            --brand-color: #4299e1; --brand-color-hover: #2b6cb0;
            --button-destructive-bg: #f56565; --button-destructive-hover: #e53e3e;
            --aog-color: #f56565;
        }
        
        @supports ((-webkit-backdrop-filter: none) or (backdrop-filter: none)) {
            .sidebar {
                -webkit-backdrop-filter: blur(12px);
                backdrop-filter: blur(12px);
                background-color: var(--sidebar-bg);
            }
            .glass-modal {
                 -webkit-backdrop-filter: blur(12px);
                backdrop-filter: blur(12px);
                 background-color: var(--sidebar-bg);
            }
        }

        body {
            font-family: 'Inter Tight', sans-serif;
            background-color: var(--bg-primary); color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Standardized Component Styles --- */
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-primary); }
        .form-input {
            width: 100%; transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 42px; padding: 0.5rem 0.875rem; font-size: 0.875rem;
            border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border);
        }
        .form-input::placeholder { color: var(--placeholder-color); }
        .form-input:focus, .form-input:focus-within {
            outline: 2px solid transparent; outline-offset: 2px;
            border-color: var(--ring-color); box-shadow: 0 0 0 2px var(--ring-color);
        }
        textarea.form-input { height: auto; resize: none; overflow-y: hidden; }
        select.form-input { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding-right: 2.5rem; background-image: none; height: 42px; }
        .field-label { color: var(--text-secondary); }

        /* --- Print Styles --- */
        @page { size: A4; margin: 15mm; }
        @media print {
            .no-print { display: none !important; } .print-only { display: block !important; }
            html.light, body { background-color: white !important; color: black !important; font-size: 10pt; }
            .main-content { margin-left: 0 !important; padding: 0 !important; }
            .document-container { box-shadow: none !important; border: none !important; margin: 0 !important; padding: 0 !important; width: 100% !important; max-width: 100% !important; border-radius: 0 !important; background-color: white !important; }
            .items-table { width: 100% !important; border-collapse: collapse !important; table-layout: fixed !important; }
            .items-table th, .items-table td {
                border: 1px solid #e5e7eb !important; padding: 6px !important; vertical-align: top !important; text-align: left !important; color: black !important;
                white-space: pre-wrap !important; word-wrap: break-word !important; overflow-wrap: break-word !important;
            }
            .items-table th { background-color: #f9fafb !important; -webkit-print-color-adjust: exact; color-adjust: exact; font-weight: 600; }
            .items-table .table-actions-column { display: none !important; }
            .items-table td[data-align="center"] { text-align: center !important; }
            .items-table td[data-align="right"] { text-align: right !important; }
            .section-no-break { page-break-inside: avoid !important; }
            .print-contact-link { color: #004477 !important; text-decoration: none; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Icon Components (SVGs) ---
        const PurchaseIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>);
        const ExchangeIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>);
        const RepairIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>);
        const DeliveryIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>);
        const CustomsIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"></path><line x1="2" y1="20" x2="2.01" y2="20"></line><path d="M15 9l-1 4 4-1-1 4-4-1"></path></svg>);
        const ClearIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const AddCircleIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>);
        const DeleteIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const ChevronDownIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>);
        const SunIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>);
        const MoonIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>);
        const EditIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>);
        const UsersIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>);
        const CopyIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>);
        const TrashIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>);
        const HistoryIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"></path><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>);
        const CheckIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>);
        const ChevronsLeftIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="11 17 6 12 11 7"></polyline><polyline points="18 17 13 12 18 7"></polyline></svg>);
        const ChevronsRightIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg>);
        const MenuIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>);
        const SaveIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>);
        const PrintIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>);
        const PlusIcon = ({ className }) => (<svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);

        // --- Constants & Utility Functions ---
        const fleetairLogoSrc = 'https://i.postimg.cc/15Dks5GN/fleet-logo-font-DIwsota-D-1-1.png';
        const printLogoSrc = 'https://i.postimg.cc/15Dks5GN/fleet-logo-font-DIwsota-D-1-1.png';
        const signatureSealSrc = 'https://i.postimg.cc/fRzBpxMk/Sign-seal-Fleet-Air.png';
        const footerLogoSrc = 'https://i.postimg.cc/7YBgCSnv/fleetair-B-004477.png';
        const COMPANY_INFO = {
            name: "Fleet Air International Kft.", address: "Vecsés, Fő út 218, 2220, Hungary",
            phone: "+36 70 221 6324", email: "logistics@fleetair.eu",
            sita_aftn: "SITA: BUDFA7X | AFTN: KAIRFRFX", eori_vat: "EORI: 13-09-114210 | VAT: HU13819822"
        };
        const initialKnownVendors = (() => {
            const vendors = [
                { id: "custom", name: "Custom Address", data: {} },
                // ... (rest of vendors omitted for brevity)
                { id: "tronair-inc", name: "Tronair Inc.", data: { name: "Tronair Inc.", legal_address: "1 Air Cargo Pkwy E, Swanton, OH 43558, USA", email: "hkarvani@tronair.com", phone: "+1-419-866-6301" } }
            ];
            const sortedOtherVendors = vendors.filter(v => v.id !== 'custom').sort((a, b) => a.name.localeCompare(b.name));
            return [vendors.find(v => v.id === 'custom'), ...sortedOtherVendors];
        })();
        const SHIPPER_VENDORS = [
            { id: 'fleetair-bud', name: 'Fleet Air International (Budapest)', data: { name: 'Fleet Air International Kft.', legal_address: '218 Fo Ut\nVecses 2220\nHungary', phone: '+36207778976', email: 'logistics@fleetair.eu' } },
            { id: 'fleetair-hof', name: 'Fleet Air International (Hof)', data: { name: 'Fleet Air International Kft.', legal_address: 'Flughafen Hof-Plauen GmbH & Co. KG\nPirk 20\n95032 Hof', phone: '49-15115286982', email: 'logistics@fleetair.eu' } },
            { id: 'custom', name: 'Custom Address', data: {} }
        ];
        const AIRCRAFT_OPTIONS = [
            { label: 'Select Aircraft...', value: '' },
            { label: 'HA-KAN', value: 'ATR42-320 HA-KAN: MSN 121' },
            { label: 'HA-KAM', value: 'ATR42-320 HA-KAM: MSN 066' },
            { label: 'HA-KAO', value: 'ATR72-202 HA-KAO: MSN 183' },
            { label: 'HA-KAT', value: 'ATR72-202 HA-KAT: MSN 108' },
            { label: 'HA-KAU', value: 'ATR72-202 HA-KAU: MSN 198' },
            { label: 'HA-KAZ', value: 'ATR72-202 HA-KAZ: MSN 195' },
            { label: 'HA-KAX', value: 'ATR72-202 HA-KAX: MSN 381' },
            { label: 'HA-KAW', value: 'ATR72-202 HA-KAW: MSN 313' },
            { label: 'HA-KAY', value: 'ATR72-202 HA-KAY: MSN 227' },
            { label: 'HA-KAI', value: 'ATR72-202 HA-KAI: MSN 265' }
        ];
        const SHIPPING_OPTIONS = [
            { label: 'Select Shipping...', value: ''},
            { label: 'None', value: 'none' },
            { label: 'FedEx', value: 'fedex', account: '390747209' },
            { label: 'DHL', value: 'dhl', account: '952441447' },
            { label: 'Custom', value: 'custom' },
        ];
        const CURRENCY_OPTIONS = [ { label: 'USD', value: 'USD' }, { label: 'GBP', value: 'GBP' }, { label: 'HUF', value: 'HUF' }, { label: 'EUR', value: 'EUR' }];
        const CD_OPTIONS = [ { label: 'NEW', value: 'NEW' }, { label: 'OH', value: 'OH' }, { label: 'REP', value: 'REP' }, { label: 'INS', value: 'INS' }, { label: 'MOD', value: 'MOD' }, { label: 'U/S', value: 'U/S' }, { label: 'SV', value: 'SV' }];
        const getTodayDate = () => new Date().toISOString().split('T')[0];

        // --- Static Definitions (Moved outside App for performance) ---
        const docTypes = [
            { key: 'purchaseOrder', title: 'Purchase Order', icon: PurchaseIcon },
            { key: 'exchangeOrder', title: 'Exchange Order', icon: ExchangeIcon },
            { key: 'repairOrder', title: 'Repair Order', icon: RepairIcon },
            { key: 'deliveryNote', title: 'Delivery Note', icon: DeliveryIcon },
            { key: 'customsInvoice', title: 'Customs Invoice', icon: CustomsIcon },
        ];
        const docHeaders = {
            purchaseOrder: [ { key: 'details', label: 'Description & Part No.', width: 'w-[45%]' }, { key: 'qty', label: 'QTY', type: 'number', align: 'right', width: 'w-[8%]' }, { key: 'cd', label: 'CD', type: 'select', options: CD_OPTIONS, align: 'center', width: 'w-[12%]' }, { key: 'price_each', label: 'Price Each', type: 'currency', align: 'right', width: 'w-[15%]' }, { key: 'amount', label: 'Amount', type: 'currency', align: 'right', readOnly: true, width: 'w-[15%]' } ],
            exchangeOrder: [ { key: 'details', label: 'Description & Part No.', width: 'w-[35%]' }, { key: 'qty', label: 'QTY', type: 'number', align: 'right', width: 'w-[8%]' }, { key: 'cd', label: 'CD', type: 'select', options: CD_OPTIONS, align: 'center', width: 'w-[12%]' }, { key: 'exchange_fee', label: 'Exchange Fee', type: 'currency', align: 'right', width: 'w-[15%]' }, { key: 'core_value', label: 'Core Value', type: 'currency', align: 'right', width: 'w-[15%]' }, { key: 'amount', label: 'Amount', type: 'currency', align: 'right', readOnly: true, width: 'w-[15%]' } ],
            repairOrder: [ { key: 'details', label: 'Description, Part/Serial No.', width: 'w-[35%]' }, { key: 'tsn', label: 'TSN', width: 'w-[10%]' }, { key: 'csn', label: 'CSN', width: 'w-[10%]' }, { key: 'tso', label: 'TSO', width: 'w-[10%]' }, { key: 'cso', label: 'CSO', width: 'w-[10%]' }, { key: 'est_cost', label: 'Est. Price', type: 'currency', align: 'right', width: 'w-[15%]' } ],
            deliveryNote: [ { key: 'details', label: 'Description, Part/Serial No.', width: 'w-[45%]' }, { key: 'qty', label: 'QTY', type: 'number', align: 'right', width: 'w-[8%]' }, { key: 'dimensions', label: 'Dims', type: 'dimensions', align: 'right', width: 'w-[15%]' }, { key: 'weight', label: 'Weight', type: 'weight', align: 'right', width: 'w-[15%]' } ],
            customsInvoice: [ { key: 'details', label: 'Part No. & Description', width: 'w-[45%]' }, { key: 'hs_code', label: 'HS Code', width: 'w-[12%]' }, { key: 'country_of_origin', label: 'C/O', type: 'country_select', align: 'center', width: 'w-[8%]' }, { key: 'qty', label: 'Qty', type: 'number', align: 'right', width: 'w-[8%]' }, { key: 'unit_value', label: 'Unit Value', type: 'currency', align: 'right', width: 'w-[12%]' }, { key: 'total_value', label: 'Total Value', type: 'currency', align: 'right', readOnly: true, width: 'w-[12%]' } ],
        };
        const docFieldKeys = {
            number: { purchaseOrder: 'po_no', exchangeOrder: 'po_no', repairOrder: 'po_no', deliveryNote: 'internal_order_no', customsInvoice: 'reference_no' },
            date: { purchaseOrder: 'po_date', exchangeOrder: 'po_date', repairOrder: 'po_date', deliveryNote: 'packing_date', customsInvoice: 'date' }
        };

const COUNTRY_OPTIONS = [ { "label": "Select Country...", "value": "", "abbr": "" }, { "label": "Afghanistan", "value": "AF", "abbr": "AFG" }, { "label": "Albania", "value": "AL", "abbr": "ALB" }, { "label": "Algeria", "value": "DZ", "abbr": "DZA" }, { "label": "Andorra", "value": "AD", "abbr": "AND" }, { "label": "Angola", "value": "AO", "abbr": "AGO" }, { "label": "Antigua and Barbuda", "value": "AG", "abbr": "ATG" }, { "label": "Argentina", "value": "AR", "abbr": "ARG" }, { "label": "Armenia", "value": "AM", "abbr": "ARM" }, { "label": "Australia", "value": "AU", "abbr": "AUS" }, { "label": "Austria", "value": "AT", "abbr": "AUT" }, { "label": "Azerbaijan", "value": "AZ", "abbr": "AZE" }, { "label": "Bahamas", "value": "BS", "abbr": "BHS" }, { "label": "Bahrain", "value": "BH", "abbr": "BHR" }, { "label": "Bangladesh", "value": "BD", "abbr": "BGD" }, { "label": "Barbados", "value": "BB", "abbr": "BRB" }, { "label": "Belarus", "value": "BY", "abbr": "BLR" }, { "label": "Belgium", "value": "BE", "abbr": "BEL" }, { "label": "Belize", "value": "BZ", "abbr": "BLZ" }, { "label": "Benin", "value": "BJ", "abbr": "BEN" }, { "label": "Bhutan", "value": "BT", "abbr": "BTN" }, { "label": "Bolivia", "value": "BO", "abbr": "BOL" }, { "label": "Bosnia and Herzegovina", "value": "BA", "abbr": "BIH" }, { "label": "Botswana", "value": "BW", "abbr": "BWA" }, { "label": "Brazil", "value": "BR", "abbr": "BRA" }, { "label": "Brunei", "value": "BN", "abbr": "BRN" }, { "label": "Bulgaria", "value": "BG", "abbr": "BGR" }, { "label": "Burkina Faso", "value": "BF", "abbr": "BFA" }, { "label": "Burundi", "value": "BI", "abbr": "BDI" }, { "label": "Cabo Verde", "value": "CV", "abbr": "CPV" }, { "label": "Cambodia", "value": "KH", "abbr": "KHM" }, { "label": "Cameroon", "value": "CM", "abbr": "CMR" }, { "label": "Canada", "value": "CA", "abbr": "CAN" }, { "label": "Central African Republic", "value": "CF", "abbr": "CAF" }, { "label": "Chad", "value": "TD", "abbr": "TCD" }, { "label": "Chile", "value": "CL", "abbr": "CHL" }, { "label": "China", "value": "CN", "abbr": "CHN" }, { "label": "Colombia", "value": "CO", "abbr": "COL" }, { "label": "Comoros", "value": "KM", "abbr": "COM" }, { "label": "Congo, Democratic Republic of the", "value": "CD", "abbr": "COD" }, { "label": "Congo, Republic of the", "value": "CG", "abbr": "COG" }, { "label": "Costa Rica", "value": "CR", "abbr": "CRI" }, { "label": "Cote d'Ivoire", "value": "CI", "abbr": "CIV" }, { "label": "Croatia", "value": "HR", "abbr": "HRV" }, { "label": "Cuba", "value": "CU", "abbr": "CUB" }, { "label": "Cyprus", "value": "CY", "abbr": "CYP" }, { "label": "Czech Republic", "value": "CZ", "abbr": "CZE" }, { "label": "Denmark", "value": "DK", "abbr": "DNK" }, { "label": "Djibouti", "value": "DJ", "abbr": "DJI" }, { "label": "Dominica", "value": "DM", "abbr": "DMA" }, { "label": "Dominican Republic", "value": "DO", "abbr": "DOM" }, { "label": "Ecuador", "value": "EC", "abbr": "ECU" }, { "label": "Egypt", "value": "EG", "abbr": "EGY" }, { "label": "El Salvador", "value": "SV", "abbr": "SLV" }, { "label": "Equatorial Guinea", "value": "GQ", "abbr": "GNQ" }, { "label": "Eritrea", "value": "ER", "abbr": "ERI" }, { "label": "Estonia", "value": "EE", "abbr": "EST" }, { "label": "Eswatini", "value": "SZ", "abbr": "SWZ" }, { "label": "Ethiopia", "value": "ET", "abbr": "ETH" }, { "label": "Fiji", "value": "FJ", "abbr": "FJI" }, { "label": "Finland", "value": "FI", "abbr": "FIN" }, { "label": "France", "value": "FR", "abbr": "FRA" }, { "label": "Gabon", "value": "GA", "abbr": "GAB" }, { "label": "Gambia", "value": "GM", "abbr": "GMB" }, { "label": "Georgia", "value": "GE", "abbr": "GEO" }, { "label": "Germany", "value": "DE", "abbr": "DEU" }, { "label": "Ghana", "value": "GH", "abbr": "GHA" }, { "label": "Greece", "value": "GR", "abbr": "GRC" }, { "label": "Grenada", "value": "GD", "abbr": "GRD" }, { "label": "Guatemala", "value": "GT", "abbr": "GTM" }, { "label": "Guinea", "value": "GN", "abbr": "GIN" }, { "label": "Guinea-Bissau", "value": "GW", "abbr": "GNB" }, { "label": "Guyana", "value": "GY", "abbr": "GUY" }, { "label": "Haiti", "value": "HT", "abbr": "HTI" }, { "label": "Honduras", "value": "HN", "abbr": "HND" }, { "label": "Hungary", "value": "HU", "abbr": "HUN" }, { "label": "Iceland", "value": "IS", "abbr": "ISL" }, { "label": "India", "value": "IN", "abbr": "IND" }, { "label": "Indonesia", "value": "ID", "abbr": "IDN" }, { "label": "Iran", "value": "IR", "abbr": "IRN" }, { "label": "Iraq", "value": "IQ", "abbr": "IRQ" }, { "label": "Ireland", "value": "IE", "abbr": "IRL" }, { "label": "Israel", "value": "IL", "abbr": "ISR" }, { "label": "Italy", "value": "IT", "abbr": "ITA" }, { "label": "Jamaica", "value": "JM", "abbr": "JAM" }, { "label": "Japan", "value": "JP", "abbr": "JPN" }, { "label": "Jordan", "value": "JO", "abbr": "JOR" }, { "label": "Kazakhstan", "value": "KZ", "abbr": "KAZ" }, { "label": "Kenya", "value": "KE", "abbr": "KEN" }, { "label": "Kiribati", "value": "KI", "abbr": "KIR" }, { "label": "Kuwait", "value": "KW", "abbr": "KWT" }, { "label": "Kyrgyzstan", "value": "KG", "abbr": "KGZ" }, { "label": "Laos", "value": "LA", "abbr": "LAO" }, { "label": "Latvia", "value": "LV", "abbr": "LVA" }, { "label": "Lebanon", "value": "LB", "abbr": "LBN" }, { "label": "Lesotho", "value": "LS", "abbr": "LSO" }, { "label": "Liberia", "value": "LR", "abbr": "LBR" }, { "label": "Libya", "value": "LY", "abbr": "LBY" }, { "label": "Liechtenstein", "value": "LI", "abbr": "LIE" }, { "label": "Lithuania", "value": "LT", "abbr": "LTU" }, { "label": "Luxembourg", "value": "LU", "abbr": "LUX" }, { "label": "Madagascar", "value": "MG", "abbr": "MDG" }, { "label": "Malawi", "value": "MW", "abbr": "MWI" }, { "label": "Malaysia", "value": "MY", "abbr": "MYS" }, { "label": "Maldives", "value": "MV", "abbr": "MDV" }, { "label": "Mali", "value": "ML", "abbr": "MLI" }, { "label": "Malta", "value": "MT", "abbr": "MLT" }, { "label": "Marshall Islands", "value": "MH", "abbr": "MHL" }, { "label": "Mauritania", "value": "MR", "abbr": "MRT" }, { "label": "Mauritius", "value": "MU", "abbr": "MUS" }, { "label": "Mexico", "value": "MX", "abbr": "MEX" }, { "label": "Micronesia", "value": "FM", "abbr": "FSM" }, { "label": "Moldova", "value": "MD", "abbr": "MDA" }, { "label": "Monaco", "value": "MC", "abbr": "MCO" }, { "label": "Mongolia", "value": "MN", "abbr": "MNG" }, { "label": "Montenegro", "value": "ME", "abbr": "MNE" }, { "label": "Morocco", "value": "MA", "abbr": "MAR" }, { "label": "Mozambique", "value": "MZ", "abbr": "MOZ" }, { "label": "Myanmar", "value": "MM", "abbr": "MMR" }, { "label": "Namibia", "value": "NA", "abbr": "NAM" }, { "label": "Nauru", "value": "NR", "abbr": "NRU" }, { "label": "Nepal", "value": "NP", "abbr": "NPL" }, { "label": "Netherlands", "value": "NL", "abbr": "NLD" }, { "label": "New Zealand", "value": "NZ", "abbr": "NZL" }, { "label": "Nicaragua", "value": "NI", "abbr": "NIC" }, { "label": "Niger", "value": "NE", "abbr": "NER" }, { "label": "Nigeria", "value": "NG", "abbr": "NGA" }, { "label": "North Korea", "value": "KP", "abbr": "PRK" }, { "label": "North Macedonia", "value": "MK", "abbr": "MKD" }, { "label": "Norway", "value": "NO", "abbr": "NOR" }, { "label": "Oman", "value": "OM", "abbr": "OMN" }, { "label": "Pakistan", "value": "PK", "abbr": "PAK" }, { "label": "Palau", "value": "PW", "abbr": "PLW" }, { "label": "Panama", "value": "PA", "abbr": "PAN" }, { "label": "Papua New Guinea", "value": "PG", "abbr": "PNG" }, { "label": "Paraguay", "value": "PY", "abbr": "PRY" }, { "label": "Peru", "value": "PE", "abbr": "PER" }, { "label": "Philippines", "value": "PH", "abbr": "PHL" }, { "label": "Poland", "value": "PL", "abbr": "POL" }, { "label": "Portugal", "value": "PT", "abbr": "PRT" }, { "label": "Qatar", "value": "QA", "abbr": "QAT" }, { "label": "Romania", "value": "RO", "abbr": "ROU" }, { "label": "Russia", "value": "RU", "abbr": "RUS" }, { "label": "Rwanda", "value": "RW", "abbr": "RWA" }, { "label": "Saint Kitts and Nevis", "value": "KN", "abbr": "KNA" }, { "label": "Saint Lucia", "value": "LC", "abbr": "LCA" }, { "label": "Saint Vincent and the Grenadines", "value": "VC", "abbr": "VCT" }, { "label": "Samoa", "value": "WS", "abbr": "WSM" }, { "label": "San Marino", "value": "SM", "abbr": "SMR" }, { "label": "Sao Tome and Principe", "value": "ST", "abbr": "STP" }, { "label": "Saudi Arabia", "value": "SA", "abbr": "SAU" }, { "label": "Senegal", "value": "SN", "abbr": "SEN" }, { "label": "Serbia", "value": "RS", "abbr": "SRB" }, { "label": "Seychelles", "value": "SC", "abbr": "SYC" }, { "label": "Sierra Leone", "value": "SL", "abbr": "SLE" }, { "label": "Singapore", "value": "SG", "abbr": "SGP" }, { "label": "Slovakia", "value": "SK", "abbr": "SVK" }, { "label": "Slovenia", "value": "SI", "abbr": "SVN" }, { "label": "Solomon Islands", "value": "SB", "abbr": "SLB" }, { "label": "Somalia", "value": "SO", "abbr": "SOM" }, { "label": "South Africa", "value": "ZA", "abbr": "ZAF" }, { "label": "South Korea", "value": "KR", "abbr": "KOR" }, { "label": "South Sudan", "value": "SS", "abbr": "SSD" }, { "label": "Spain", "value": "ES", "abbr": "ESP" }, { "label": "Sri Lanka", "value": "LK", "abbr": "LKA" }, { "label": "Sudan", "value": "SD", "abbr": "SDN" }, { "label": "Suriname", "value": "SR", "abbr": "SUR" }, { "label": "Sweden", "value": "SE", "abbr": "SWE" }, { "label": "Switzerland", "value": "CH", "abbr": "CHE" }, { "label": "Syria", "value": "SY", "abbr": "SYR" }, { "label": "Taiwan", "value": "TW", "abbr": "TWN" }, { "label": "Tajikistan", "value": "TJ", "abbr": "TJK" }, { "label": "Tanzania", "value": "TZ", "abbr": "TZA" }, { "label": "Thailand", "value": "TH", "abbr": "THA" }, { "label": "Timor-Leste", "value": "TL", "abbr": "TLS" }, { "label": "Togo", "value": "TG", "abbr": "TGO" }, { "label": "Tonga", "value": "TO", "abbr": "TON" }, { "label": "Trinidad and Tobago", "value": "TT", "abbr": "TTO" }, { "label": "Tunisia", "value": "TN", "abbr": "TUN" }, { "label": "Turkey", "value": "TR", "abbr": "TUR" }, { "label": "Turkmenistan", "value": "TM", "abbr": "TKM" }, { "label": "Tuvalu", "value": "TV", "abbr": "TUV" }, { "label": "Uganda", "value": "UG", "abbr": "UGA" }, { "label": "Ukraine", "value": "UA", "abbr": "UKR" }, { "label": "United Arab Emirates", "value": "AE", "abbr": "ARE" }, { "label": "United Kingdom", "value": "GB", "abbr": "GBR" }, { "label": "United States", "value": "US", "abbr": "USA" }, { "label": "Uruguay", "value": "UY", "abbr": "URY" }, { "label": "Uzbekistan", "value": "UZ", "abbr": "UZB" }, { "label": "Vanuatu", "value": "VU", "abbr": "VUT" }, { "label": "Vatican City", "value": "VA", "abbr": "VAT" }, { "label": "Venezuela", "value": "VE", "abbr": "VEN" }, { "label": "Vietnam", "value": "VN", "abbr": "VNM" }, { "label": "Yemen", "value": "YE", "abbr": "YEM" }, { "label": "Zambia", "value": "ZM", "abbr": "ZMB" }, { "label": "Zimbabwe", "value": "ZW", "abbr": "ZWE" } ];

        // --- Data Schemas & Definitions ---
        const createEmptyItem = (docType) => {
            const baseItem = { id: crypto.randomUUID(), parts_description: '', part_no: '', qty: 1 };
            const specifics = {
                purchaseOrder: { cd: 'NEW', price_each: '', amount: '' },
                exchangeOrder: { cd: 'NEW', exchange_fee: '', core_value: '', amount: '' },
                repairOrder: { serial_number: '', est_cost: '', tsn: '', csn: '', tso: '', cso: '' },
                deliveryNote: { serial_number: '', dimensions: '', weight: '' },
                customsInvoice: { hs_code: '', country_of_origin: '', unit_value: '', total_value: '' },
            };
            return { ...baseItem, ...specifics[docType] };
        };
        const getBlankDocData = () => ({
            purchaseOrder: { title: 'PURCHASE ORDER', po_no: '', po_date: getTodayDate(), supplierAddress: {}, consigneeAddress: {}, items: [createEmptyItem('purchaseOrder')], currency: 'USD', priority: 'normal', shipping_method: '', custom_shipping: '', shipping_account: '', notes: '', payment_terms: '', delivery_terms: '' },
            exchangeOrder: { title: 'EXCHANGE ORDER', po_no: '', po_date: getTodayDate(), supplierAddress: {}, consigneeAddress: {}, items: [createEmptyItem('exchangeOrder')], currency: 'USD', priority: 'normal', shipping_method: '', custom_shipping: '', shipping_account: '', notes: '', payment_terms: '', delivery_terms: '' },
            repairOrder: { title: 'REPAIR ORDER', po_no: '', po_date: getTodayDate(), reason_for_removal: '', type_of_work: '', supplierAddress: {}, consigneeAddress: {}, items: [createEmptyItem('repairOrder')], currency: 'USD', priority: 'normal', ac_type: '', notes: '', payment_terms: '', delivery_terms: '' },
            deliveryNote: { title: 'DELIVERY NOTE', internal_order_no: '', packing_date: getTodayDate(), shipperAddress: {}, consigneeAddress: {}, items: [createEmptyItem('deliveryNote')], driver_name: '', license_plate_number: '', priority: 'normal', total_packages: '', total_weight: '', notes: '' },
            customsInvoice: { title: 'CUSTOMS INVOICE', reference_no: '', date: getTodayDate(), awb_tracking_no: '', shipperAddress: {}, consigneeAddress: {}, items: [createEmptyItem('customsInvoice')], currency: 'USD', total_packages: '', total_gross_weight: '', total_net_weight: '', priority: 'normal', notes: '' },
        });
        const docTypeColors = {
            purchaseOrder: 'text-blue-700 dark:text-blue-400', exchangeOrder: 'text-purple-700 dark:text-purple-400',
            repairOrder: 'text-green-700 dark:text-green-400', deliveryNote: 'text-orange-700 dark:text-orange-400',
            customsInvoice: 'text-gray-700 dark:text-gray-400'
        };

        // --- Reusable UI Components ---
        const InputShell = ({ children, label, className }) => (
            <div className={`w-full ${className}`}>
                {label && <label className="block text-sm font-medium field-label mb-1.5">{label}</label>}
                <div className="relative w-full">{children}</div>
            </div>
        );
        const TextInput = React.forwardRef((props, ref) => <input ref={ref} className="form-input" {...props} />);
        const TextareaInput = React.memo(React.forwardRef(({ value, ...props }, ref) => {
            const internalRef = React.useRef(null);
            React.useImperativeHandle(ref, () => internalRef.current);
            React.useLayoutEffect(() => {
                const el = internalRef.current;
                if (el) { 
                    el.style.height = 'auto'; 
                    el.style.height = `${el.scrollHeight}px`; 
                }
            }, [value]);
            return <textarea ref={internalRef} className="form-input" value={value || ''} rows={1} {...props} />;
        }));
        const SelectInput = React.forwardRef(({ options, placeholder, className, ...props }, ref) => (
            <div className="relative w-full">
                <select ref={ref} className={`form-input w-full ${!props.value ? 'placeholder-shown' : ''} ${className}`} {...props}>
                    {placeholder && <option value="" disabled hidden>{placeholder}</option>}
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                    <ChevronDownIcon className="h-5 w-5 text-gray-400" />
                </div>
            </div>
        ));
        const NumericInput = React.forwardRef(({ value, onChange, currency, unit, unitType, ...props }, ref) => {
            const [displayValue, setDisplayValue] = React.useState('');
            const getUnitLabel = () => {
                if (!unitType) return null;
                if (unitType === 'weight') return unit === 'metric' ? 'kg' : 'lbs';
                if (unitType === 'length') return unit === 'metric' ? 'cm' : 'in';
                return null;
            };
            const unitLabel = getUnitLabel();
            React.useEffect(() => {
                if (value === null || value === undefined || value === '') {
                    setDisplayValue('');
                    return;
                }
                const num = Number(value);
                if (!isNaN(num)) {
                    const options = currency ? { minimumFractionDigits: 2, maximumFractionDigits: 2 } : { maximumFractionDigits: 2 };
                    setDisplayValue(num.toLocaleString('en-US', options));
                } else {
                    setDisplayValue(String(value));
                }
            }, [value, currency]);
            const handleChange = (e) => setDisplayValue(e.target.value);
            const handleBlur = () => {
                const num = parseFloat(displayValue.replace(/,/g, ''));
                const finalValue = isNaN(num) ? '' : num;
                onChange({ target: { value: finalValue } });
            };
            return (
                <div className="relative w-full flex items-center">
                    {currency && <span className="absolute left-3 text-sm pointer-events-none text-gray-500">{currency}</span>}
                    <input ref={ref} type="text" inputMode="decimal" className={`form-input text-right ${currency ? 'pl-10' : ''} ${unitLabel ? 'pr-12' : ''}`} value={displayValue} onChange={handleChange} onBlur={handleBlur} {...props} />
                    {unitLabel && <span className="absolute right-3 text-sm pointer-events-none text-gray-500">{unitLabel}</span>}
                </div>
            );
        });
        const DateInput = React.forwardRef(({ value, onChange, onClear, ...props }, ref) => (
            <div className="relative w-full flex items-center">
                <input ref={ref} type="date" className="form-input" value={value || ''} onChange={onChange} {...props} style={{paddingRight: '2.5rem'}} />
                {value && <button type="button" onClick={onClear} className="absolute right-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 no-print"><ClearIcon className="h-4 w-4" /></button>}
            </div>
        ));
        const ConfirmationDialog = ({ isOpen, title, message, onConfirm, onCancel, confirmText = "Confirm" }) => isOpen && (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
                <div className="card glass-modal p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-[var(--border-primary)]">
                    <h3 className="text-lg font-semibold mb-2">{title}</h3>
                    <p className="text-sm text-[var(--text-secondary)] mb-4">{message}</p>
                    <div className="flex justify-end space-x-3">
                        <button onClick={onCancel} className="px-4 py-2 rounded-md font-medium bg-[var(--bg-tertiary)] hover:bg-[var(--hover-bg)] border border-[var(--border-primary)] transition transform active:scale-95">Cancel</button>
                        <button onClick={onConfirm} className="px-4 py-2 rounded-md bg-[var(--button-destructive-bg)] text-white font-medium hover:bg-[var(--button-destructive-hover)] transition transform active:scale-95">{confirmText}</button>
                    </div>
                </div>
            </div>
        );
        const PrioritySwitch = ({ priority, onChange }) => {
            const isAOG = priority === 'AOG';
            return (
                <div className="flex bg-[var(--bg-tertiary)] rounded-lg p-1 space-x-1 shadow-inner h-11 w-auto">
                    <button onClick={() => onChange('normal')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all w-full transform active:scale-95 ${!isAOG ? 'bg-[var(--brand-color)] text-white shadow' : 'text-[var(--text-inactive)] hover:bg-[var(--hover-bg)]'}`}>Normal</button>
                    <button onClick={() => onChange('AOG')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all w-full transform active:scale-95 ${isAOG ? 'bg-[var(--aog-color)] text-white shadow' : 'text-[var(--text-inactive)] hover:bg-[var(--hover-bg)]'}`}>AOG</button>
                </div>
            );
        };
         const UnitSwitch = ({ unit, onChange }) => {
            return (
                <div className="flex bg-[var(--bg-tertiary)] rounded-lg p-1 space-x-1 shadow-inner h-11 w-auto">
                    <button onClick={() => onChange('metric')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all w-full transform active:scale-95 ${unit === 'metric' ? 'bg-[var(--brand-color)] text-white shadow' : 'text-[var(--text-inactive)] hover:bg-[var(--hover-bg)]'}`}>Metric</button>
                    <button onClick={() => onChange('imperial')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all w-full transform active:scale-95 ${unit === 'imperial' ? 'bg-[var(--brand-color)] text-white shadow' : 'text-[var(--text-inactive)] hover:bg-[var(--hover-bg)]'}`}>Imperial</button>
                </div>
            );
        };

        // --- Core Document Components ---
        const VendorCombobox = ({ value, onSelect, disabled, vendorList }) => {
            const [query, setQuery] = React.useState(value || '');
            const [isOpen, setIsOpen] = React.useState(false);
            const containerRef = React.useRef(null);
            React.useEffect(() => { setQuery(value || '') }, [value]);
            const filteredVendors = query === '' ? vendorList : vendorList.filter(v => v.name.toLowerCase().includes(query.toLowerCase()));
            const handleSelect = (vendor) => {
                onSelect(vendor);
                setQuery(vendor.id === 'custom' ? '' : vendor.name);
                setIsOpen(false);
            };
            const handleClear = () => {
                onSelect({ id: 'custom', name: '', data: {} });
                setQuery('');
                setIsOpen(false);
            };
            React.useEffect(() => {
                const handleClickOutside = (event) => { if (containerRef.current && !containerRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return (
                <div className="relative" ref={containerRef}>
                    <div className="relative">
                        <TextInput value={query} onChange={e => { setQuery(e.target.value); setIsOpen(true); }} onFocus={() => setIsOpen(true)} placeholder="Search or type for custom..." disabled={disabled} />
                        {query && <button type="button" onClick={handleClear} className="absolute inset-y-0 right-8 flex items-center pr-2 text-gray-400 hover:text-gray-600 transition transform active:scale-90"><ClearIcon className="h-4 w-4" /></button>}
                        <button type="button" className="absolute inset-y-0 right-0 flex items-center pr-2 transition transform active:scale-90" onClick={() => setIsOpen(!isOpen)} disabled={disabled}><ChevronDownIcon className="h-5 w-5 text-gray-400" /></button>
                    </div>
                    {isOpen && filteredVendors.length > 0 && (
                        <ul className="absolute z-10 w-full card rounded-md mt-1 max-h-60 overflow-auto shadow-lg">
                            {filteredVendors.map(vendor => (
                                <li key={vendor.id} onClick={() => handleSelect(vendor)} className={`px-4 py-2 cursor-pointer text-sm hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)] ${vendor.id === 'custom' ? 'font-bold border-b border-[var(--border-secondary)]' : ''}`}>{vendor.name}</li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };
        const AddressSection = ({ title, address, onAddressChange, onSaveVendor, knownVendors }) => {
            const [selectedVendorId, setSelectedVendorId] = React.useState('custom');
            const handleVendorSelect = (vendor) => {
                setSelectedVendorId(vendor.id);
                onAddressChange(vendor.id === 'custom' ? { name: '', legal_address: '', phone: '', email: '' } : { ...vendor.data });
            };
            const handleFieldChange = (field, value) => {
                onAddressChange({ ...address, [field]: value });
                setSelectedVendorId('custom');
            };
            const isCustom = !knownVendors.some(v => v.name === address?.name && v.id !== 'custom');
            const isCustomAndFilled = isCustom && address?.name;
            return (
                <div>
                    <h3 className="text-lg font-bold mb-3 text-[var(--text-primary)] no-print">{title}</h3>
                    <div className="space-y-3 no-print">
                        <InputShell label="Search/Select Vendor"><VendorCombobox value={address?.name} onSelect={handleVendorSelect} vendorList={knownVendors} /></InputShell>
                        <InputShell label="Company Name"><TextInput value={address?.name || ''} onChange={e => handleFieldChange('name', e.target.value)} disabled={!isCustom} /></InputShell>
                        <InputShell label="Address"><TextareaInput value={address?.legal_address || ''} onChange={e => handleFieldChange('legal_address', e.target.value)} disabled={!isCustom} /></InputShell>
                        <InputShell label="Phone"><TextInput value={address?.phone || ''} onChange={e => handleFieldChange('phone', e.target.value)} disabled={!isCustom} /></InputShell>
                        <InputShell label="Email / Contact"><TextInput value={address?.email || ''} onChange={e => handleFieldChange('email', e.target.value)} disabled={!isCustom} /></InputShell>
                        {isCustomAndFilled && onSaveVendor && (
                            <div className="no-print pt-2"><button onClick={() => onSaveVendor(address)} className="w-full px-4 py-2 rounded-md bg-green-600 text-white font-medium hover:bg-green-700 transition transform active:scale-95">Save as New Vendor</button></div>
                        )}
                    </div>
                    <div className="print-only whitespace-pre-wrap text-sm">
                        <h3 className="font-bold mb-1">{title}</h3>
                        <p className="font-bold">{address?.name}</p>
                        <p>{address?.legal_address}</p>
                        {address?.phone && <p><a className="print-contact-link" href={`tel:${address.phone.replace(/[^\d+]/g, '')}`}>{address.phone}</a></p>}
                        {address?.email && <p><a className="print-contact-link" href={`mailto:${address.email}`}>{address.email}</a></p>}
                    </div>
                </div>
            );
        };
        const ItemsTable = ({ items, updateItem, onItemsChange, currency, onCurrencyChange, docType, headers, units, onUnitChange }) => {
            const addItem = () => onItemsChange([...items, createEmptyItem(docType)]);
            const removeItem = index => onItemsChange(items.filter((_, i) => i !== index));
            const totalAmount = React.useMemo(() => {
                if (!items) return 0;
                const key = { purchaseOrder: 'amount', exchangeOrder: 'amount', repairOrder: 'est_cost', customsInvoice: 'total_value' }[docType] || 'amount';
                return items.reduce((sum, item) => sum + (Number(item[key]) || 0), 0);
            }, [items, docType]);
            
            const renderCellInput = (item, index, header) => {
                const commonProps = { value: item[header.key], readOnly: header.readOnly };
                switch (header.type) {
                    case 'select': return <SelectInput {...commonProps} options={header.options} placeholder="CD" onChange={e => updateItem(index, header.key, e.target.value)} />;
                    case 'country_select': return <SelectInput {...commonProps} options={COUNTRY_OPTIONS} placeholder="Select C/O" onChange={e => updateItem(index, header.key, e.target.value)} />;
                    case 'currency': return <NumericInput {...commonProps} currency={currency} onChange={e => updateItem(index, header.key, e.target.value)} />;
                    case 'number': return <NumericInput {...commonProps} onChange={e => updateItem(index, header.key, e.target.value)} />;
                    case 'dimensions': return <TextInput {...commonProps} onChange={e => updateItem(index, header.key, e.target.value)} placeholder="e.g. 10x20x30" />;
                    case 'weight': return <NumericInput {...commonProps} unit={units} unitType="weight" onChange={e => updateItem(index, header.key, e.target.value)} />;
                    default: return <TextInput {...commonProps} onChange={e => updateItem(index, header.key, e.target.value)} />;
                }
            };

            return (
                <div className="section-no-break my-4">
                    <div className="overflow-x-auto print:overflow-visible">
                        <table className={`min-w-full items-table border-collapse ${docType}-table`}>
                             <thead className="border-b-2 border-[var(--border-primary)]">
                                <tr>
                                    {headers.map(h => <th key={h.key} className={`p-3 text-left text-sm font-semibold uppercase tracking-wider text-[var(--text-secondary)] ${h.width}`}>{h.label}</th>)}
                                    <th className="table-actions-column p-2 w-12 no-print"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {items.map((item, index) => (
                                    <tr key={item.id} className="border-b border-[var(--border-secondary)]">
                                        {headers.map(header => (
                                            <td key={header.key} data-label={header.label} data-align={header.align} className="p-2 align-top">
                                                <div className="no-print">
                                                    {header.key === 'details' ? (
                                                        <div className="space-y-2">
                                                            <TextareaInput placeholder="Description" value={item.parts_description} onChange={e => updateItem(index, 'parts_description', e.target.value)} />
                                                            {['repairOrder', 'deliveryNote'].includes(docType) ? (
                                                                <div className="flex gap-x-2"><TextInput placeholder="Part No." value={item.part_no} onChange={e => updateItem(index, 'part_no', e.target.value)} /><TextInput placeholder="Serial No." value={item.serial_number} onChange={e => updateItem(index, 'serial_number', e.target.value)} /></div>
                                                            ) : (<TextInput placeholder="Part No." value={item.part_no} onChange={e => updateItem(index, 'part_no', e.target.value)} />)}
                                                        </div>
                                                    ) : renderCellInput(item, index, header)}
                                                </div>
                                                <div className="print-only">
                                                    {header.key === 'details' ? (
                                                        <>
                                                            <strong>{item.part_no}</strong>
                                                            {item.serial_number && <span className="block text-xs">S/N: {item.serial_number}</span>}
                                                            <p className="mt-1">{item.parts_description}</p>
                                                        </>
                                                    ) : header.key === 'country_of_origin' ? (
                                                        COUNTRY_OPTIONS.find(c => c.value === item.country_of_origin)?.abbr || item.country_of_origin
                                                    ) : header.type === 'currency' ? `${currency} ${Number(item[header.key] || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}`
                                                      : (header.key === 'weight' && item[header.key]) ? `${item[header.key]} ${units === 'metric' ? 'kg' : 'lbs'}`
                                                      : (header.key === 'dimensions' && item[header.key]) ? `${item[header.key]} ${units === 'metric' ? 'cm' : 'in'}`
                                                      : item[header.key]
                                                    }
                                                </div>
                                            </td>
                                        ))}
                                        <td className="table-actions-column text-center no-print p-0 align-top pt-2.5"><button type="button" onClick={() => removeItem(index)} className="p-1 text-red-500 hover:text-red-700 transition transform active:scale-90"><DeleteIcon className="h-5 w-5" /></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        <div className="no-print mt-4 flex justify-between items-center">
                            <button type="button" onClick={addItem} className="flex items-center px-4 py-2 rounded-lg bg-[var(--brand-color)] text-white text-sm font-medium hover:bg-[var(--brand-color-hover)] transition transform active:scale-95"><AddCircleIcon className="h-5 w-5 mr-2" />Add Item</button>
                             <div className="flex items-center justify-end gap-x-4">
                                {['deliveryNote', 'customsInvoice'].includes(docType) && <UnitSwitch unit={units} onChange={onUnitChange} />}
                                {['purchaseOrder', 'exchangeOrder', 'repairOrder', 'customsInvoice'].includes(docType) && (
                                    <>
                                        <span className="font-bold text-lg">Total{docType === 'repairOrder' && ' Est'}:</span>
                                        <div className="flex items-center gap-x-2"><div className="w-24"><SelectInput options={CURRENCY_OPTIONS} value={currency} onChange={onCurrencyChange} /></div>
                                            <span className="font-bold w-32 text-right text-xl">{Number(totalAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        const VendorManagementModal = ({ isOpen, onClose, vendors, setVendors, showNotification, allDocsData, setAllDocsData }) => {
            const [editingVendor, setEditingVendor] = React.useState(null);
            const [vendorToDelete, setVendorToDelete] = React.useState(null);
            const [searchQuery, setSearchQuery] = React.useState('');
            if (!isOpen) return null;
            const customVendors = vendors.filter(v => !['custom', 'fleetair-bud', 'fleetair-hof'].includes(v.id) && v.data.name);
            const filteredVendors = customVendors.filter(vendor => vendor.name.toLowerCase().includes(searchQuery.toLowerCase()));
            const handleSave = () => {
                if (!editingVendor.data.name) {
                    showNotification("Vendor name cannot be empty.");
                    return;
                }
                const originalVendor = vendors.find(v => v.id === editingVendor.id);
                if (!originalVendor) {
                    console.error("Could not find original vendor to update.");
                    showNotification("An error occurred while saving.");
                    return;
                }
                const originalName = originalVendor.name;
                const updatedVendorData = { ...editingVendor, name: editingVendor.data.name };
                const updatedVendors = vendors.map(v => v.id === editingVendor.id ? updatedVendorData : v);
                setVendors(updatedVendors);
                const updatedDocsData = JSON.parse(JSON.stringify(allDocsData));
                Object.keys(updatedDocsData).forEach(docKey => {
                    const doc = updatedDocsData[docKey];
                    const supplierKey = doc.hasOwnProperty('supplierAddress') ? 'supplierAddress' : 'shipperAddress';
                    if (doc[supplierKey] && doc[supplierKey].name === originalName) { doc[supplierKey] = { ...editingVendor.data }; }
                    if (doc.consigneeAddress && doc.consigneeAddress.name === originalName) { doc.consigneeAddress = { ...editingVendor.data };}
                });
                setAllDocsData(updatedDocsData);
                setEditingVendor(null);
                showNotification("Vendor updated successfully.");
            };
            const handleConfirmDelete = () => {
                if (!vendorToDelete) return;
                const vendorNameToDelete = vendorToDelete.name;
                const updatedVendors = vendors.filter(v => v.id !== vendorToDelete.id);
                setVendors(updatedVendors);
                const updatedDocsData = JSON.parse(JSON.stringify(allDocsData));
                Object.keys(updatedDocsData).forEach(docKey => {
                    const doc = updatedDocsData[docKey];
                    if (doc.supplierAddress && doc.supplierAddress.name === vendorNameToDelete) { doc.supplierAddress = {}; }
                    if (doc.shipperAddress && doc.shipperAddress.name === vendorNameToDelete) { doc.shipperAddress = {}; }
                    if (doc.consigneeAddress && doc.consigneeAddress.name === vendorNameToDelete) { doc.consigneeAddress = {}; }
                });
                setAllDocsData(updatedDocsData);
                setVendorToDelete(null);
                showNotification(`Vendor "${vendorNameToDelete}" deleted.`);
            };
            const handleFieldChange = (field, value) => setEditingVendor(prev => ({ ...prev, data: { ...prev.data, [field]: value } }));
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
                    <div className="card glass-modal p-6 rounded-lg shadow-xl max-w-2xl w-full mx-4 border-[var(--border-primary)] flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Manage Custom Vendors</h2>
                            <button onClick={onClose} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><ClearIcon className="h-6 w-6" /></button>
                        </div>
                        <div className="mb-4">
                            <TextInput type="text" placeholder="Search vendors..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                        </div>
                        <div className="flex-grow overflow-y-auto max-h-[60vh]">
                            {editingVendor ? (
                                <div className="space-y-4 p-4 bg-[var(--bg-tertiary)] rounded-lg">
                                    <h3 className="font-semibold">Editing: {editingVendor.name}</h3>
                                    <InputShell label="Company Name"><TextInput value={editingVendor.data.name || ''} onChange={e => handleFieldChange('name', e.target.value)} /></InputShell>
                                    <InputShell label="Address"><TextareaInput value={editingVendor.data.legal_address || ''} onChange={e => handleFieldChange('legal_address', e.target.value)} /></InputShell>
                                    <InputShell label="Phone"><TextInput value={editingVendor.data.phone || ''} onChange={e => handleFieldChange('phone', e.target.value)} /></InputShell>
                                    <InputShell label="Email / Contact"><TextInput value={editingVendor.data.email || ''} onChange={e => handleFieldChange('email', e.target.value)} /></InputShell>
                                    <div className="flex justify-end space-x-3 pt-2">
                                        <button onClick={() => setEditingVendor(null)} className="px-4 py-2 rounded-md font-medium bg-[var(--bg-secondary)] hover:bg-[var(--hover-bg)] border border-[var(--border-primary)] transition transform active:scale-95">Cancel</button>
                                        <button onClick={handleSave} className="px-4 py-2 rounded-md bg-[var(--brand-color)] text-white font-medium hover:bg-[var(--brand-color-hover)] transition transform active:scale-95">Save Changes</button>
                                    </div>
                                </div>
                            ) : (
                                <ul className="space-y-2">
                                    {filteredVendors.map(vendor => (
                                        <li key={vendor.id} className="flex items-center justify-between p-3 rounded-md hover:bg-[var(--hover-bg)]">
                                            <span className="font-medium">{vendor.name}</span>
                                            <div className="space-x-2">
                                                <button onClick={() => setEditingVendor(vendor)} className="p-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition transform active:scale-90"><EditIcon className="h-5 w-5" /></button>
                                                <button onClick={() => setVendorToDelete(vendor)} className="p-2 text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 transition transform active:scale-90"><DeleteIcon className="h-5 w-5" /></button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                     <ConfirmationDialog isOpen={!!vendorToDelete} title="Delete Vendor" message={`Are you sure you want to delete "${vendorToDelete?.name}"? This will remove it from the list and clear it from any documents where it's currently used.`} onConfirm={handleConfirmDelete} onCancel={() => setVendorToDelete(null)} confirmText="Yes, Delete" />
                </div>
            );
        };
        const HistoryModal = ({ isOpen, onClose, documents, onLoad, onDelete, onUseAsTemplate }) => {
            const [searchQuery, setSearchQuery] = React.useState('');
            const [docToDelete, setDocToDelete] = React.useState(null);
            if (!isOpen) return null;
            const getDocNumber = (doc) => {
                if(!doc) return 'N/A';
                const keyMap = { purchaseOrder: 'po_no', exchangeOrder: 'po_no', repairOrder: 'po_no', deliveryNote: 'internal_order_no', customsInvoice: 'reference_no' };
                return doc[keyMap[doc.docType]] || 'N/A';
            };
            const filteredDocs = documents.filter(doc => {
                const docNumber = getDocNumber(doc).toLowerCase();
                const docTitle = doc.title.toLowerCase();
                const searchTerm = searchQuery.toLowerCase();
                return docNumber.includes(searchTerm) || docTitle.includes(searchTerm);
            });
            const handleDeleteClick = (doc) => setDocToDelete(doc);
            const confirmDelete = () => { if (docToDelete) { onDelete(docToDelete.id); setDocToDelete(null); }};
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
                    <div className="card glass-modal p-6 rounded-lg shadow-xl max-w-4xl w-full mx-4 border-[var(--border-primary)] flex flex-col h-[80vh]">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">Document History</h2>
                            <button onClick={onClose} className="text-[var(--text-secondary)] hover:text-[var(--text-primary)]"><ClearIcon className="h-6 w-6" /></button>
                        </div>
                        <div className="mb-4">
                            <TextInput type="text" placeholder="Search by title or number..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} />
                        </div>
                        <div className="flex-grow overflow-y-auto">
                            {filteredDocs.length > 0 ? (
                                <ul className="space-y-3">
                                    {filteredDocs.map(doc => (
                                        <li key={doc.id} className="p-3 rounded-md bg-[var(--bg-tertiary)] border border-[var(--border-secondary)]">
                                            <div className="flex flex-wrap items-center justify-between gap-y-2">
                                                <div className="flex-grow">
                                                    <p className="font-bold text-lg">{doc.title} - <span className="font-medium">{getDocNumber(doc)}</span></p>
                                                    <p className="text-xs text-[var(--text-secondary)]">Saved on: {new Date(doc.savedAt).toLocaleString()}</p>
                                                </div>
                                                <div className="flex items-center space-x-2 flex-shrink-0">
                                                    <button onClick={() => onLoad(doc.id)} className="px-3 py-1.5 text-sm rounded-md font-medium bg-blue-600 text-white hover:bg-blue-700 transition transform active:scale-95">Load</button>
                                                    <button onClick={() => onUseAsTemplate(doc.id)} className="px-3 py-1.5 text-sm rounded-md font-medium bg-gray-500 text-white hover:bg-gray-600 transition transform active:scale-95">Use as Template</button>
                                                    <button onClick={() => handleDeleteClick(doc)} className="p-2 text-red-500 hover:text-red-700 transition transform active:scale-90"><TrashIcon className="h-5 w-5" /></button>
                                                </div>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="text-center py-10 text-[var(--text-secondary)]">
                                    <p>No saved documents found.</p>
                                    {searchQuery && <p>Try adjusting your search.</p>}
                                </div>
                            )}
                        </div>
                    </div>
                    <ConfirmationDialog isOpen={!!docToDelete} title="Delete Document" message={`Are you sure you want to delete this document (${docToDelete?.title} - ${getDocNumber(docToDelete)})? This action cannot be undone.`} onConfirm={confirmDelete} onCancel={() => setDocToDelete(null)} confirmText="Yes, Delete" />
                </div>
            );
        };
        const CopyToModal = ({ isOpen, onClose, onSelect, docTypes, currentDocType }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print">
                    <div className="card glass-modal p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-[var(--border-primary)]">
                        <h2 className="text-xl font-bold mb-4">Copy Current Info To...</h2>
                        <div className="space-y-2">
                            {docTypes.filter(dt => dt.key !== currentDocType).map(doc => (
                                <button key={doc.key} onClick={() => onSelect(doc.key)} className="w-full text-left px-4 py-2 rounded-md hover:bg-[var(--hover-bg)] transition transform active:scale-95">{doc.title}</button>
                            ))}
                        </div>
                        <div className="flex justify-end mt-4">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-medium bg-[var(--bg-tertiary)] hover:bg-[var(--hover-bg)] border border-[var(--border-primary)] transition transform active:scale-95">Cancel</button>
                        </div>
                    </div>
                </div>
            );
        };
        const MobileMenuModal = ({ isOpen, onClose, onHistory, onVendors, onThemeToggle, activeTheme }) => {
            if (!isOpen) return null;
             return (
                <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 no-print md:hidden">
                    <div className="card glass-modal p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 border-[var(--border-primary)]">
                        <h2 className="text-xl font-bold mb-4">Menu</h2>
                        <div className="space-y-2">
                             <button onClick={onHistory} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]"><HistoryIcon className="h-6 w-6 flex-shrink-0" /><span className="ml-4 font-medium">History</span></button>
                            <button onClick={onVendors} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]"><UsersIcon className="h-6 w-6 flex-shrink-0" /><span className="ml-4 font-medium">Manage Vendors</span></button>
                            <button onClick={onThemeToggle} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]">{activeTheme === 'light' ? <MoonIcon className="h-6 w-6 flex-shrink-0" /> : <SunIcon className="h-6 w-6 flex-shrink-0 text-yellow-400" />}<span className="ml-4 font-medium">Toggle Theme</span></button>
                        </div>
                         <div className="flex justify-end mt-4">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-medium bg-[var(--bg-tertiary)] hover:bg-[var(--hover-bg)] border border-[var(--border-primary)] transition transform active:scale-95">Close</button>
                        </div>
                    </div>
                </div>
            );
        };
        const FloatingActionButton = ({ onClear, onSave, onPrint, saveState }) => {
            const [isOpen, setIsOpen] = React.useState(false);

            return (
                <div className="fixed bottom-24 right-6 z-40 md:hidden no-print">
                    <div className="relative flex flex-col items-center gap-y-3">
                        {isOpen && (
                            <>
                                <div className="flex items-center gap-x-3">
                                    <span className="bg-gray-800 text-white text-xs px-2 py-1 rounded-md">Print / PDF</span>
                                    <button onClick={onPrint} className="bg-[var(--brand-color)] hover:bg-[var(--brand-color-hover)] text-white p-3 rounded-full shadow-lg transition transform active:scale-95"><PrintIcon className="h-6 w-6" /></button>
                                </div>
                                <div className="flex items-center gap-x-3">
                                     <span className="bg-gray-800 text-white text-xs px-2 py-1 rounded-md">{saveState === 'saving' ? 'Saved!' : 'Save'}</span>
                                    <button onClick={onSave} disabled={saveState === 'saving'} className={`text-white p-3 rounded-full shadow-lg transition-all transform active:scale-95 ${saveState === 'saving' ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-700'}`}>{saveState === 'saving' ? <CheckIcon className="h-6 w-6"/> : <SaveIcon className="h-6 w-6"/>}</button>
                                </div>
                                <div className="flex items-center gap-x-3">
                                     <span className="bg-gray-800 text-white text-xs px-2 py-1 rounded-md">Clear</span>
                                    <button onClick={onClear} className="bg-[var(--button-destructive-bg)] hover:bg-[var(--button-destructive-hover)] text-white p-3 rounded-full shadow-lg transition transform active:scale-95"><TrashIcon className="h-6 w-6" /></button>
                                </div>
                            </>
                        )}
                        <button onClick={() => setIsOpen(!isOpen)} className={`bg-[var(--brand-color)] hover:bg-[var(--brand-color-hover)] text-white p-4 rounded-full shadow-lg transition-transform duration-300 ${isOpen ? 'rotate-45' : 'rotate-0'}`}>
                            <PlusIcon className="h-8 w-8" />
                        </button>
                    </div>
                </div>
            );
        };


        // --- Main App Component ---
        const App = () => {
            const [docType, setDocType] = React.useState('purchaseOrder');
            const [allDocsData, setAllDocsData] = React.useState(() => { try { const saved = localStorage.getItem('fleetairDocGenData_v2'); return saved ? JSON.parse(saved) : getBlankDocData(); } catch { return getBlankDocData(); }});
            const [knownVendors, setKnownVendors] = React.useState(() => { try { const saved = localStorage.getItem('fleetairKnownVendors_v2'); return saved ? JSON.parse(saved) : initialKnownVendors; } catch { return initialKnownVendors; }});
            const [savedDocuments, setSavedDocuments] = React.useState(() => { try { const saved = localStorage.getItem('fleetairDocHistory_v1'); return saved ? JSON.parse(saved) : []; } catch { return []; }});
            const [activeTheme, setActiveTheme] = React.useState(() => localStorage.getItem('theme') || 'light');
            const [units, setUnits] = React.useState(() => localStorage.getItem('unitPreference') || 'metric');
            const [showClearConfirm, setShowClearConfirm] = React.useState(false);
            const [showClearAllConfirm, setShowClearAllConfirm] = React.useState(false);
            const [isVendorModalOpen, setIsVendorModalOpen] = React.useState(false);
            const [isHistoryModalOpen, setIsHistoryModalOpen] = React.useState(false);
            const [isCopyModalOpen, setIsCopyModalOpen] = React.useState(false);
            const [copyRequest, setCopyRequest] = React.useState(null);
            const [saveState, setSaveState] = React.useState('idle');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(true);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);

            React.useEffect(() => { localStorage.setItem('fleetairDocGenData_v2', JSON.stringify(allDocsData)); }, [allDocsData]);
            React.useEffect(() => { localStorage.setItem('fleetairKnownVendors_v2', JSON.stringify(knownVendors)); }, [knownVendors]);
            React.useEffect(() => { localStorage.setItem('fleetairDocHistory_v1', JSON.stringify(savedDocuments)); }, [savedDocuments]);
            React.useEffect(() => { document.documentElement.className = activeTheme; localStorage.setItem('theme', activeTheme); }, [activeTheme]);
            React.useEffect(() => { localStorage.setItem('unitPreference', units); }, [units]);
            React.useEffect(() => {
                const handleBeforePrint = () => { document.documentElement.className = 'light'; };
                const handleAfterPrint = () => { document.documentElement.className = activeTheme; };
                window.addEventListener('beforeprint', handleBeforePrint);
                window.addEventListener('afterprint', handleAfterPrint);
                return () => { window.removeEventListener('beforeprint', handleBeforePrint); window.removeEventListener('afterprint', handleAfterPrint); };
            }, [activeTheme]);
            
            const updateCurrentDoc = React.useCallback((field, value) => { setAllDocsData(prev => ({ ...prev, [docType]: { ...prev[docType], [field]: value } })); }, [docType]);
            
            const updateItem = React.useCallback((index, field, value) => {
                const newItems = [...(allDocsData[docType].items || [])];
                const item = { ...newItems[index], [field]: value };
                const qty = Number(item.qty) || 0;
                if (docType === 'purchaseOrder') item.amount = qty * (Number(item.price_each) || 0);
                else if (docType === 'exchangeOrder') item.amount = qty * (Number(item.exchange_fee) || 0);
                else if (docType === 'customsInvoice') item.total_value = qty * (Number(item.unit_value) || 0);
                newItems[index] = item;
                updateCurrentDoc('items', newItems);
            }, [docType, allDocsData, updateCurrentDoc]);

            const handleSaveVendor = React.useCallback((address) => {
                if (!address.name || knownVendors.some(v => v.name.toLowerCase() === address.name.toLowerCase())) { return; }
                const newVendor = { id: address.name.toLowerCase().replace(/\s+/g, '-'), name: address.name, data: address };
                const updatedVendors = [...knownVendors, newVendor].sort((a, b) => {
                    if (a.id === 'custom') return -1; if (b.id === 'custom') return 1; return a.name.localeCompare(b.name);
                });
                setKnownVendors(updatedVendors);
            }, [knownVendors]);

            const handleClearCurrentDoc = () => { setAllDocsData(prev => ({ ...prev, [docType]: getBlankDocData()[docType] })); setShowClearConfirm(false); };
            const handleClearAllDocs = () => { setAllDocsData(getBlankDocData()); setShowClearAllConfirm(false); };
            
            const handlePrint = () => {
                const originalTitle = document.title;
                const docNumber = currentDocData[numberFieldKey] || 'Untitled';
                const docTitle = currentDocData.title.replace(/\s+/g, '_');
                document.title = `${docTitle}_${docNumber}`;
                window.print();
                document.title = originalTitle;
            };
            const handleInitiateCopy = (targetDocType) => { setIsCopyModalOpen(false); setCopyRequest({ source: docType, target: targetDocType }); };
            
            const handleExecuteCopy = () => {
                if (!copyRequest) return;
                const { source: sourceDocType, target: targetDocType } = copyRequest;
                const sourceData = allDocsData[sourceDocType];
                let newDocData = JSON.parse(JSON.stringify(allDocsData[targetDocType]));
                const keyMap = {
                    number: { purchaseOrder: 'po_no', exchangeOrder: 'po_no', repairOrder: 'po_no', deliveryNote: 'internal_order_no', customsInvoice: 'reference_no' },
                    date: { purchaseOrder: 'po_date', exchangeOrder: 'po_date', repairOrder: 'po_date', deliveryNote: 'packing_date', customsInvoice: 'date' },
                    supplier: { purchaseOrder: 'supplierAddress', exchangeOrder: 'supplierAddress', repairOrder: 'supplierAddress', deliveryNote: 'shipperAddress', customsInvoice: 'shipperAddress' }
                };
                const sourceNumberKey = keyMap.number[sourceDocType];
                const targetNumberKey = keyMap.number[targetDocType];
                if(sourceData[sourceNumberKey]) newDocData[targetNumberKey] = sourceData[sourceNumberKey];
                const sourceDateKey = keyMap.date[sourceDocType];
                const targetDateKey = keyMap.date[targetDocType];
                 if(sourceData[sourceDateKey]) newDocData[targetDateKey] = sourceData[sourceDateKey];
                const sourceSupplierKey = keyMap.supplier[sourceDocType];
                const targetSupplierKey = keyMap.supplier[targetDocType];
                newDocData[targetSupplierKey] = sourceData[sourceSupplierKey] || {};
                newDocData.consigneeAddress = sourceData.consigneeAddress || {};
                newDocData.priority = sourceData.priority || 'normal';
                newDocData.notes = sourceData.notes || '';
                if (sourceData.items && sourceData.items.length > 0) {
                    newDocData.items = sourceData.items.map(sourceItem => {
                        let newItem = createEmptyItem(targetDocType);
                        newItem.parts_description = sourceItem.parts_description || '';
                        newItem.part_no = sourceItem.part_no || '';
                        newItem.qty = sourceItem.qty || 1;
                        if ('serial_number' in sourceItem && 'serial_number' in newItem) { newItem.serial_number = sourceItem.serial_number; }
                        return newItem;
                    });
                } else { newDocData.items = [createEmptyItem(targetDocType)]; }
                setAllDocsData(prev => ({ ...prev, [targetDocType]: newDocData }));
                setDocType(targetDocType);
                setCopyRequest(null);
            };

            const handleSaveDocument = () => {
                const docToSave = { ...currentDocData, docType, savedAt: new Date().toISOString(), id: crypto.randomUUID() };
                const newHistory = [docToSave, ...savedDocuments];
                setSavedDocuments(newHistory);
                setSaveState('saving');
                setTimeout(() => {setSaveState('idle');}, 1500);
            };
            const handleLoadDocument = (docId) => {
                const docToLoad = savedDocuments.find(d => d.id === docId);
                if (docToLoad) {
                    const { docType: loadedDocType, ...docData } = docToLoad;
                    setDocType(loadedDocType);
                    setAllDocsData(prev => ({ ...prev, [loadedDocType]: docData }));
                    setIsHistoryModalOpen(false);
                }
            };
            const handleDeleteDocument = (docId) => {
                setSavedDocuments(savedDocuments.filter(d => d.id !== docId));
            };
            const handleUseAsTemplate = (docId) => {
                const docToUse = savedDocuments.find(d => d.id === docId);
                if (docToUse) {
                    const { docType: sourceDocType, ...sourceData } = docToUse;
                    let newDocData = JSON.parse(JSON.stringify(currentDocData));
                    const keyMap = { supplier: { purchaseOrder: 'supplierAddress', exchangeOrder: 'supplierAddress', repairOrder: 'supplierAddress', deliveryNote: 'shipperAddress', customsInvoice: 'shipperAddress' }};
                    const sourceSupplierKey = keyMap.supplier[sourceDocType];
                    const targetSupplierKey = keyMap.supplier[docType];
                    newDocData[targetSupplierKey] = sourceData[sourceSupplierKey] || {};
                    newDocData.consigneeAddress = sourceData.consigneeAddress || {};
                    newDocData.priority = sourceData.priority || 'normal';
                    if (sourceData.items && sourceData.items.length > 0) {
                        newDocData.items = sourceData.items.map(sourceItem => {
                            let newItem = createEmptyItem(docType);
                            newItem.parts_description = sourceItem.parts_description || '';
                            newItem.part_no = sourceItem.part_no || '';
                            newItem.qty = sourceItem.qty || 1;
                            if ('serial_number' in sourceItem && 'serial_number' in newItem) { newItem.serial_number = sourceItem.serial_number; }
                            return newItem;
                        });
                    } else { newDocData.items = [createEmptyItem(docType)];}
                    setAllDocsData(prev => ({...prev, [docType]: newDocData}));
                    setIsHistoryModalOpen(false);
                }
            };

            const currentDocData = allDocsData[docType];
            const currentHeaders = docHeaders[docType];
            const numberFieldKey = docFieldKeys.number[docType];
            const dateFieldKey = docFieldKeys.date[docType];
            const docTypeConfig = docTypes.find(d => d.key === docType);

            const totalAmount = React.useMemo(() => {
                const items = currentDocData.items || [];
                const key = { purchaseOrder: 'amount', exchangeOrder: 'amount', repairOrder: 'est_cost', customsInvoice: 'total_value' }[docType] || 'amount';
                return items.reduce((sum, item) => sum + (Number(item[key]) || 0), 0);
            }, [currentDocData.items, docType]);

            const showTotal = ['purchaseOrder', 'exchangeOrder', 'repairOrder', 'customsInvoice'].includes(docType);

            return (
                <div className="flex h-screen w-full bg-[var(--bg-primary)]">
                    <aside className={`sidebar fixed top-0 left-0 h-full border-r border-[var(--border-primary)] flex-col p-4 transition-all duration-300 no-print hidden md:flex ${isSidebarOpen ? 'w-64 items-start' : 'w-20 items-center'}`}>
                        <div className={`flex items-center w-full mb-10 ${!isSidebarOpen && 'justify-center'}`}>
                            <img src={fleetairLogoSrc} alt="Fleetair Logo" className="h-10 flex-shrink-0" />
                            <h1 className={`text-xl font-bold ml-3 text-[var(--text-primary)] transition-opacity duration-200 whitespace-nowrap ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>DocGen 2.0</h1>
                        </div>
                        <nav className="flex flex-col space-y-2 w-full">
                            {docTypes.map(doc => (
                                <button key={doc.key} onClick={() => setDocType(doc.key)} className={`flex items-center p-3 rounded-lg w-full text-left transition-colors duration-200 ${docType === doc.key ? 'bg-[var(--brand-color)] text-white shadow-md' : 'text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]'}`}>
                                    <doc.icon className="h-6 w-6 flex-shrink-0" />
                                    <span className={`ml-4 font-medium whitespace-nowrap transition-opacity duration-200 ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>{doc.title}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="mt-auto w-full space-y-2">
                             <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]">
                                {isSidebarOpen ? <ChevronsLeftIcon className="h-6 w-6 flex-shrink-0" /> : <ChevronsRightIcon className="h-6 w-6 flex-shrink-0" />}
                                <span className={`ml-4 font-medium whitespace-nowrap transition-opacity duration-200 ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>Collapse</span>
                            </button>
                            <button onClick={() => setIsHistoryModalOpen(true)} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]"><HistoryIcon className="h-6 w-6 flex-shrink-0" /><span className={`ml-4 font-medium whitespace-nowrap transition-opacity duration-200 ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>History</span></button>
                            <button onClick={() => setIsVendorModalOpen(true)} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]"><UsersIcon className="h-6 w-6 flex-shrink-0" /><span className={`ml-4 font-medium whitespace-nowrap transition-opacity duration-200 ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>Manage Vendors</span></button>
                            <button onClick={() => setActiveTheme(activeTheme === 'light' ? 'dark' : 'light')} className="flex items-center p-3 rounded-lg w-full text-left text-[var(--text-secondary)] hover:bg-[var(--hover-bg)] hover:text-[var(--hover-text)]">{activeTheme === 'light' ? <MoonIcon className="h-6 w-6 flex-shrink-0" /> : <SunIcon className="h-6 w-6 flex-shrink-0 text-yellow-400" />}<span className={`ml-4 font-medium whitespace-nowrap transition-opacity duration-200 ${isSidebarOpen ? 'opacity-100' : 'opacity-0'}`}>Toggle Theme</span></button>
                        </div>
                    </aside>

                    <main className={`main-content flex-1 overflow-y-auto transition-all duration-300 md:${isSidebarOpen ? 'ml-64' : 'ml-20'} pt-20 pb-28 md:pt-6 md:pb-6 px-6 lg:px-8`}>
                        {/* --- Mobile Header --- */}
                        <header className="md:hidden fixed top-0 left-0 right-0 bg-[var(--sidebar-bg)] border-b border-[var(--border-primary)] p-4 flex items-center justify-between z-40 no-print" style={{backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)'}}>
                             <div className="w-1/3"><img src={fleetairLogoSrc} alt="Fleetair Logo" className="h-8" /></div>
                             <div className="w-1/3 text-center"><h2 className="text-lg font-bold text-[var(--text-primary)]">{docTypeConfig.title.split(' ')[0]}</h2></div>
                             <div className="w-1/3 flex justify-end"><button onClick={() => setIsMobileMenuOpen(true)} className="p-2"><MenuIcon className="h-6 w-6 text-[var(--text-primary)]"/></button></div>
                        </header>

                        <div className="max-w-7xl mx-auto">
                            <header className="hidden md:flex flex-wrap items-center justify-between gap-4 mb-8 no-print">
                                <div><h2 className="text-3xl font-bold text-[var(--text-primary)]">{docTypeConfig.title}</h2><p className="text-[var(--text-secondary)] mt-1">Fill in the details below to generate your document.</p></div>
                                <div className="flex items-center space-x-3">
                                    <button onClick={() => setShowClearConfirm(true)} className="px-5 py-2.5 rounded-lg font-semibold shadow-sm bg-[var(--bg-tertiary)] text-[var(--text-primary)] hover:bg-[var(--hover-bg)] border border-[var(--border-primary)] transition transform active:scale-95">Clear</button>
                                    <button onClick={handleSaveDocument} disabled={saveState === 'saving'} className={`px-5 py-2.5 rounded-lg font-semibold shadow-sm text-white transition-all duration-200 transform active:scale-95 flex items-center justify-center w-36 ${saveState === 'saving' ? 'bg-green-600' : 'bg-blue-600 hover:bg-blue-700'}`}>{saveState === 'saving' ? (<span className="flex items-center"><CheckIcon className="h-6 w-6 mr-2"/> Saved!</span>) : ('Save')}</button>
                                    <button onClick={handlePrint} className="px-5 py-2.5 rounded-lg font-semibold shadow-sm bg-[var(--brand-color)] text-white hover:bg-[var(--brand-color-hover)] transition transform active:scale-95">Print / PDF</button>
                                </div>
                            </header>

                            <div className="document-container card p-4 md:p-8 rounded-xl shadow-lg w-full">
                                {/* --- Print Header --- */}
                                <div className="hidden print-only mb-6">
                                    <div className="flex justify-between items-end pb-4 border-b border-gray-200">
                                        <div>
                                            <img src={printLogoSrc} alt="Company Logo" className="h-12 mb-2"/>
                                            <h1 className="text-xl font-bold">{COMPANY_INFO.name}</h1>
                                            <p className="text-xs">{COMPANY_INFO.address}</p>
                                            <p className="text-xs"><a className="print-contact-link" href={`tel:${COMPANY_INFO.phone.replace(/[^\d+]/g, '')}`}>{COMPANY_INFO.phone}</a> | <a className="print-contact-link" href={`mailto:${COMPANY_INFO.email}`}>{COMPANY_INFO.email}</a></p>
                                            <p className="text-xs">{COMPANY_INFO.sita_aftn}</p>
                                            <p className="text-xs">{COMPANY_INFO.eori_vat}</p>
                                        </div>
                                        <div className="text-right">
                                            <h2 className={`text-4xl font-extrabold uppercase ${docTypeColors[docType]}`}>{currentDocData.title}</h2>
                                            <div className="mt-2 text-sm">
                                                <p><span className="font-bold">No:</span> {currentDocData[numberFieldKey]}</p>
                                                <p><span className="font-bold">Date:</span> {currentDocData[dateFieldKey]}</p>
                                                {docType === 'customsInvoice' && currentDocData.awb_tracking_no && <p><span className="font-bold">AWB/Tracking:</span> {currentDocData.awb_tracking_no}</p>}
                                            </div>
                                            {currentDocData.priority === 'AOG' && !['customsInvoice'].includes(docType) && <p className="text-red-600 font-bold text-xl mt-2">AOG REQUEST</p>}
                                        </div>
                                    </div>
                                </div>

                                {/* --- Edit View Header --- */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pb-6 mb-6 border-b border-[var(--border-secondary)] no-print">
                                     <InputShell label={docType === 'customsInvoice' ? 'Reference No.' : 'Order Number'}><TextInput value={currentDocData[numberFieldKey] || ''} onChange={e => updateCurrentDoc(numberFieldKey, e.target.value)} /></InputShell>
                                     <InputShell label={docType === 'customsInvoice' ? 'Date' : 'Order Date'}><DateInput value={currentDocData[dateFieldKey] || ''} onChange={e => updateCurrentDoc(dateFieldKey, e.target.value)} onClear={() => updateCurrentDoc(dateFieldKey, '')} /></InputShell>
                                     {docType === 'customsInvoice' ? (<InputShell label="AWB/Tracking No."><TextInput value={currentDocData.awb_tracking_no || ''} onChange={e => updateCurrentDoc('awb_tracking_no', e.target.value)} /></InputShell>) : (<InputShell label="Priority"><div className="flex items-center h-full"><PrioritySwitch priority={currentDocData.priority} onChange={(val) => updateCurrentDoc('priority', val)} /></div></InputShell>)}
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 print:grid-cols-2 print:gap-x-8 gap-x-6 gap-y-8 mb-6">
                                    <AddressSection title={docType === 'deliveryNote' || docType === 'customsInvoice' ? "Shipper (From)" : "Supplier (To)"} address={currentDocData.supplierAddress || currentDocData.shipperAddress} onAddressChange={value => updateCurrentDoc(docType.includes('Note') || docType.includes('Invoice') ? 'shipperAddress' : 'supplierAddress', value)} onSaveVendor={handleSaveVendor} knownVendors={docType.includes('Note') || docType.includes('Invoice') ? SHIPPER_VENDORS : knownVendors} />
                                    <AddressSection title="Consignee (Ship To)" address={currentDocData.consigneeAddress} onAddressChange={value => updateCurrentDoc('consigneeAddress', value)} onSaveVendor={handleSaveVendor} knownVendors={knownVendors} />
                                </div>
                                
                                <ItemsTable items={currentDocData.items} updateItem={updateItem} onItemsChange={value => updateCurrentDoc('items', value)} currency={currentDocData.currency} onCurrencyChange={e => updateCurrentDoc('currency', e.target.value)} docType={docType} headers={currentHeaders} units={units} onUnitChange={setUnits} />
                                
                                <div className="no-print mt-8 pt-8 border-t border-[var(--border-secondary)]">
                                    { (docType === 'deliveryNote' || docType === 'customsInvoice') && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 section-no-break">
                                            <InputShell label="Total Packages (qty)">
                                                <NumericInput value={currentDocData.total_packages} onChange={e => updateCurrentDoc('total_packages', e.target.value)} />
                                            </InputShell>
                                            <InputShell label={`Total Gross Weight`}>
                                                <NumericInput unit={units} unitType="weight" value={docType === 'customsInvoice' ? currentDocData.total_gross_weight : currentDocData.total_weight} onChange={e => updateCurrentDoc(docType === 'customsInvoice' ? 'total_gross_weight' : 'total_weight', e.target.value)} />
                                            </InputShell>
                                            {docType === 'customsInvoice' &&
                                                <InputShell label={`Total Net Weight`}>
                                                    <NumericInput unit={units} unitType="weight" value={currentDocData.total_net_weight} onChange={e => updateCurrentDoc('total_net_weight', e.target.value)} />
                                                </InputShell>
                                            }
                                        </div>
                                    )}

                                    {docType === 'deliveryNote' && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 section-no-break">
                                            <InputShell label="Driver's Name"><TextInput value={currentDocData.driver_name} onChange={e => updateCurrentDoc('driver_name', e.target.value)} /></InputShell>
                                            <InputShell label="License Plate Number"><TextInput value={currentDocData.license_plate_number} onChange={e => updateCurrentDoc('license_plate_number', e.target.value)} /></InputShell>
                                            <InputShell label="Signature"><div className="form-input bg-[var(--bg-tertiary)]"></div></InputShell>
                                        </div>
                                    )}

                                    {docType === 'repairOrder' && (
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 section-no-break">
                                            <InputShell label="Reason for Removal"><TextareaInput value={currentDocData.reason_for_removal} onChange={e => updateCurrentDoc('reason_for_removal', e.target.value)} /></InputShell>
                                            <InputShell label="Type of Work Required"><TextareaInput value={currentDocData.type_of_work} onChange={e => updateCurrentDoc('type_of_work', e.target.value)} /></InputShell>
                                            <InputShell label="A/C Details">
                                                <SelectInput options={AIRCRAFT_OPTIONS} value={currentDocData.ac_type} onChange={e => updateCurrentDoc('ac_type', e.target.value)} placeholder="Select Aircraft..." />
                                            </InputShell>
                                        </div>
                                    )}

                                    {(docType === 'purchaseOrder' || docType === 'exchangeOrder') && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 section-no-break">
                                            <div className="flex items-end gap-x-4">
                                                <InputShell label="Please ship via:" className="w-48">
                                                    <SelectInput options={SHIPPING_OPTIONS} value={currentDocData.shipping_method} onChange={e => updateCurrentDoc('shipping_method', e.target.value)} placeholder="Select..." />
                                                </InputShell>
                                                {currentDocData.shipping_method && currentDocData.shipping_method !== 'custom' && currentDocData.shipping_method !== 'none' && (
                                                    <InputShell label="Account #">
                                                        <TextInput value={SHIPPING_OPTIONS.find(o => o.value === currentDocData.shipping_method)?.account || ''} disabled />
                                                    </InputShell>
                                                )}
                                            </div>
                                            {currentDocData.shipping_method === 'custom' && (
                                                <InputShell label="Custom Shipping Details">
                                                    <TextInput value={currentDocData.custom_shipping} onChange={e => updateCurrentDoc('custom_shipping', e.target.value)} />
                                                </InputShell>
                                            )}
                                        </div>
                                    )}
                                </div>
                            
                                <footer className="hidden print-only pt-8 mt-auto section-no-break">
                                     {docType === 'repairOrder' && (currentDocData.reason_for_removal || currentDocData.type_of_work || currentDocData.ac_type) && (
                                        <div className="grid grid-cols-3 gap-x-8 mb-4 border-b border-gray-200 pb-2">
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">REASON FOR REMOVAL: </span>{currentDocData.reason_for_removal} </div>
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">TYPE OF WORK: </span>{currentDocData.type_of_work} </div>
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">A/C DETAILS: </span>{currentDocData.ac_type} </div>
                                        </div>
                                    )}
                                    {docType === 'deliveryNote' && (currentDocData.driver_name || currentDocData.license_plate_number) && (
                                        <div className="grid grid-cols-3 gap-x-8 mb-4 border-b border-gray-200 pb-2">
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">DRIVER'S NAME: </span>{currentDocData.driver_name} </div>
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">LICENSE PLATE: </span>{currentDocData.license_plate_number} </div>
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">SIGNATURE: </span> </div>
                                        </div>
                                    )}
                                     {(docType === 'purchaseOrder' || docType === 'exchangeOrder') && currentDocData.shipping_method && currentDocData.shipping_method !== 'none' && (
                                        <div className="mb-4 border-b-2 border-gray-200 pb-2">
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">PLEASE SHIP VIA: </span>{currentDocData.shipping_method === 'custom' ? currentDocData.custom_shipping : `${SHIPPING_OPTIONS.find(o => o.value === currentDocData.shipping_method)?.label} acc #: ${SHIPPING_OPTIONS.find(o => o.value === currentDocData.shipping_method)?.account || ''}`} </div>
                                        </div>
                                    )}
                                    {(docType === 'deliveryNote' || docType === 'customsInvoice') && (currentDocData.total_packages || currentDocData.total_weight || currentDocData.total_gross_weight) && (
                                        <div className="grid grid-cols-3 gap-x-8 mb-4 border-b border-gray-200 pb-2">
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">TOTAL PACKAGES: </span>{currentDocData.total_packages} </div>
                                            <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">TOTAL GROSS WEIGHT: </span>{docType === 'customsInvoice' && currentDocData.total_gross_weight ? `${currentDocData.total_gross_weight} ${units === 'metric' ? 'kg' : 'lbs'}` : docType === 'deliveryNote' && currentDocData.total_weight ? `${currentDocData.total_weight} ${units === 'metric' ? 'kg' : 'lbs'}` : ''} </div>
                                            {docType === 'customsInvoice' && <div className="border-b border-gray-400 pb-1"> <span className="text-xs text-gray-500">TOTAL NET WEIGHT: </span>{currentDocData.total_net_weight ? `${currentDocData.total_net_weight} ${units === 'metric' ? 'kg' : 'lbs'}` : ''} </div>}
                                        </div>
                                    )}
                                     {showTotal && (
                                        <div className="print-only text-right text-lg font-bold mt-4">
                                            Total{docType === 'repairOrder' && ' Est'}: {currentDocData.currency} {Number(totalAmount).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                                        </div>
                                    )}
                                    <div className="flex justify-between items-start gap-8 mt-8">
                                        <div className="w-1/2">
                                            <img src={signatureSealSrc} alt="Signature and Seal" className="h-24" />
                                        </div>
                                        <div className="w-1/2 space-y-2">
                                            <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                                                <h3 className="font-bold text-gray-800 mb-1">Terms & Conditions:</h3>
                                                <p className="text-gray-600 text-xs">This Order is subject to Fleet Air International's standard Terms and Conditions. Please acknowledge receipt within 24 hours.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-center text-xs text-gray-500 border-t border-gray-300 pt-2 mt-6">
                                        <p>Fleet Air International Kft | VAT: HU13819822 | EASA Part-145 Approval № HU.145.0109</p>
                                    </div>
                                </footer>
                            </div>
                        </div>
                    </main>

                    {/* --- Mobile Bottom Bar & FAB --- */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-[var(--sidebar-bg)] border-t border-[var(--border-primary)] p-2 flex justify-around items-center z-40 no-print" style={{backdropFilter: 'blur(12px)', WebkitBackdropFilter: 'blur(12px)'}}>
                         {docTypes.map(doc => (
                            <button key={doc.key} onClick={() => setDocType(doc.key)} className={`flex flex-col items-center p-2 rounded-lg transition-colors duration-200 ${docType === doc.key ? 'text-[var(--brand-color)]' : 'text-[var(--text-secondary)]'}`}>
                                <doc.icon className="h-6 w-6" />
                                <span className="text-xs mt-1">{doc.title.split(' ')[0]}</span>
                            </button>
                        ))}
                    </div>

                    <FloatingActionButton 
                        onClear={() => setShowClearConfirm(true)}
                        onSave={handleSaveDocument}
                        onPrint={handlePrint}
                        saveState={saveState}
                    />

                    <ConfirmationDialog isOpen={showClearConfirm} title="Clear Form" message={`Clear all fields for this ${currentDocData.title}?`} onConfirm={handleClearCurrentDoc} onCancel={() => setShowClearConfirm(false)} confirmText="Yes, Clear"/>
                    <ConfirmationDialog isOpen={showClearAllConfirm} title="Clear All Forms" message="Are you sure you want to clear all data from every form? This action cannot be undone." onConfirm={handleClearAllDocs} onCancel={() => setShowClearAllConfirm(false)} confirmText="Yes, Clear All" />
                    <ConfirmationDialog isOpen={!!copyRequest} title="Copy Data" message={`Overwrite the ${copyRequest ? allDocsData[copyRequest.target].title : ''} form with data from the current ${copyRequest ? allDocsData[copyRequest.source].title : ''}? This can't be undone.`} onConfirm={handleExecuteCopy} onCancel={() => setCopyRequest(null)} confirmText="Yes, Copy" />
                    <CopyToModal isOpen={isCopyModalOpen} onClose={() => setIsCopyModalOpen(false)} onSelect={handleInitiateCopy} docTypes={docTypes} currentDocType={docType} />
                    <VendorManagementModal isOpen={isVendorModalOpen} onClose={() => setIsVendorModalOpen(false)} vendors={knownVendors} setVendors={setKnownVendors} showNotification={()=>{}} allDocsData={allDocsData} setAllDocsData={setAllDocsData} />
                    <HistoryModal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} documents={savedDocuments} onLoad={handleLoadDocument} onDelete={handleDeleteDocument} onUseAsTemplate={handleUseAsTemplate} />
                    <MobileMenuModal 
                        isOpen={isMobileMenuOpen}
                        onClose={() => setIsMobileMenuOpen(false)}
                        onHistory={() => { setIsMobileMenuOpen(false); setIsHistoryModalOpen(true); }}
                        onVendors={() => { setIsMobileMenuOpen(false); setIsVendorModalOpen(true); }}
                        onThemeToggle={() => setActiveTheme(activeTheme === 'light' ? 'dark' : 'light')}
                        activeTheme={activeTheme}
                    />
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>


